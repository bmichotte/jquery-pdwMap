/*
 * Copyright (c) 2013 Benjamin Michotte <benjamin@produweb.be>
 *     ProduWeb SA <http://www.produweb.be>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is furnished
 * to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
var __pdw_map_loader,pdwMapInit=function(){__pdw_map_loader.pdwMap("load");};(function($){$.fn.pdwMap=function(method){var options=$(this).data("options");if(options!=null&&options.provider!=null){if(typeof $.fn.pdwMap.providers[options.provider]=="undefined"){$.error(options.provider+" is not a valid provider");return null;}methods._dump.apply(this,[options.provider,method,Array.prototype.slice.call(arguments,1)]);}if(options!=null&&options.provider!=null&&$.fn.pdwMap.providers[options.provider][method]){return $.fn.pdwMap.providers[options.provider][method].apply(this,Array.prototype.slice.call(arguments,1));}else{if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else{if(typeof method==="object"||!method){return methods.init.apply(this,arguments);}else{$.error("Method "+method+" does not exist on jQuery.pdwMap");return null;}}}};var methods={init:function(options){options=$.extend(true,$.fn.pdwMap.defaults,options||{});return this.each(function(){$(this).data("markers",[]);$(this).data("options",options);$(this).pdwMap("_showOverlay");$(this).pdwMap("loadScript");});},load:function(){var map=$(this).pdwMap("initProvider");$(this).data("map",map);},cleanMap:function(){$(this).pdwMap("cleanMarkers");$(this).pdwMap("cleanCircle");},search:function(city,state,country,radius,type){var $this=$(this),options=$this.data("options");if(options.search!==false&&typeof options.search=="function"){options.search.apply(this,[city,state,country,radius,type]);return;}$.ajax({url:options.searchUrl,type:"POST",data:{city:city,state:state,country:country,radius:radius,types:type},dataType:"json",beforeSend:function(){$this.pdwMap("_showOverlay");$this.pdwMap("cleanMap");}}).done(function(data){if(data.result===false){alert(options.messages.noResult);return;}if(options.maps.circle.enabled){$this.pdwMap("setCenter",data.center.lat,data.center.lng,data.radius);}$this.pdwMap("addMarkers",data.markers);if(options.onMarkersAdded!==false&&typeof options.onMarkersAdded=="function"){options.onMarkersAdded.apply(this,[data.markers]);}}).fail(function(jqXHR,textStatus,errorThrown){$.error(textStatus,errorThrown);}).always(function(){$this.pdwMap("_hideOverlay");});},addMarkers:function(points){var $this=$(this);$this.data("_markers",points);$.each(points,function(i,n){$this.pdwMap("addMarker",n);});$this.pdwMap("centerMap");},formatInfo:function(point){var options=$(this).data("options");if(options.formatInfo!==false&&typeof options.formatInfo=="function"){return options.formatInfo.apply(this,point);}return{title:point.title,content:"<p>"+point.content+" </p>"};},_containerSize:function(separator){var options=$(this).data("options");return $(this).width()+separator+$(this).height();},_setMapImage:function(url){var options=$(this).data("options");var image=$("<img />").attr("src",url);$(this).append(image);$(this).pdwMap("_hideOverlay");},_hideOverlay:function(){var options=$(this).data("options");if(options.loader!==false){$(options.loader).hide();}},_showOverlay:function(){var options=$(this).data("options");if(options.loader!==false){$(options.loader).show();}},_dump:function(){var options=$(this).data("options");if(options.debug!==false&&typeof window.console!=="undefined"){window.console.log(arguments);}},_appendScriptToHead:function(script){var head;if(document.head){head=document.head;}else{if(document.getElementsByTagName("head")){head=document.getElementsByTagName("head")[0];}}if(head){$(this).pdwMap("_dump",[head,script]);head.appendChild(script);}}};$.fn.pdwMap.providers={};$.fn.pdwMap.defaults={provider:"",lang:"en",loader:false,debug:false,staticMap:false,browserGeoloc:true,marker:false,defaultPosition:{lat:48.856614,lng:2.3522219},apiKeys:{},maps:{zoom:7,circle:{stroke:"#2E799F",fill:"#2E799F"}},searchUrl:false,formatInfo:false,search:false,onMapLoaded:false,onMarkersAdded:false,onMarkerClicked:false};})(jQuery);
/**
 * Bing Maps API provider
 * http://www.microsoft.com/maps/developers/web.aspx
 */
jQuery.extend(jQuery.fn.pdwMap.providers,{bing:{loadScript:function(){var options=$(this).data("options");if(typeof options.apiKeys.bing=="undefined"){$.error("You need an api key for Bing");return;}__pdw_map_loader=$(this);if(options.staticMap){pdwMapInit();return;}var script=document.createElement("script");script.setAttribute("type","text/javascript");script.setAttribute("src","http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0&mkt="+options.lang+"&onscriptload=pdwMapInit");$(this).pdwMap("_appendScriptToHead",script);},initProvider:function(){var $this=$(this),options=$this.data("options");if(options.staticMap){var url="http://dev.virtualearth.net/REST/v1/Imagery/Map/AerialWithLabels/"+options.defaultPosition.lat+","+options.defaultPosition.lng+"/"+options.maps.zoom+"?mapSize="+$this.pdwMap("_containerSize",",")+"&key="+options.apiKeys.bing;$this.pdwMap("_setMapImage",url);return null;}var map=new Microsoft.Maps.Map($this.get(0),{credentials:options.apiKeys.bing,zoom:options.maps.zoom,enableClickableLogo:false,enableSearchLogo:false});map.entities.clear();$this.data("markers",[]);Microsoft.Maps.Events.addHandler(map,"viewchangeend",function(){if($this.data("circleArea")){var zoom=map.getZoom();var backgroundColor=Microsoft.Maps.Color.fromHex(options.maps.circle.fill),borderColor=Microsoft.Maps.Color.fromHex(options.maps.circle.stroke);backgroundColor.a=zoom<=10?60:0;borderColor.a=zoom<=10?255:0;$this.data("circleArea").setOptions({fillColor:backgroundColor,strokeColor:borderColor,strokeThickness:1});}if(options.onMapLoaded&&typeof options.onMapLoaded=="function"){self.setTimeout(function(){options.onMapLoaded.apply($this,$this);options.onMapLoaded=false;},200);}});var center=new Microsoft.Maps.Location(options.defaultPosition.lat,options.defaultPosition.lng);if(options.browserGeoloc&&navigator.geolocation){navigator.geolocation.getCurrentPosition(function(position){map.setView({center:new Microsoft.Maps.Location(position.coords.latitude,position.coords.longitude)});},function(){});}map.setView({center:center});$this.pdwMap("_hideOverlay");return map;},cleanMarkers:function(){$(this).data("map").entities.clear();$(this).data("markers",[]);},cleanCircle:function(){},addMarker:function(point){var options=$(this).data("options"),pushpinOptions={};if(options.marker!=false){if(typeof options.marker.anchor=="undefined"){options.marker.anchor={x:0,y:0};}var iconUrl=options.marker.url;if(options.marker.dynamic){iconUrl+="?type="+point.type;}pushpinOptions={icon:iconUrl,width:options.marker.size.width,height:options.marker.size.height,anchor:new Microsoft.Maps.Point(options.marker.anchor.x,options.marker.anchor.y)};}var loc=new Microsoft.Maps.Location(point.lat,point.lng),pushpin=new Microsoft.Maps.Pushpin(loc,pushpinOptions),$this=$(this);$(this).data("markers").push(loc);Microsoft.Maps.Events.addHandler(pushpin,"click",function(e){var display=$this.data("Infobox");if(display){$this.data("map").entities.remove(display);}var infoHtml=$this.pdwMap("formatInfo",point),infoboxOptions={title:infoHtml.title,description:infoHtml.content};if(point.sells&&point.sells.length>0){infoboxOptions.height=200;}display=new Microsoft.Maps.Infobox(new Microsoft.Maps.Location(point.lat,point.lng),infoboxOptions);$this.data("Infobox",display);$this.data("map").entities.push(display);if(options.onMarkerClicked&&typeof options.onMarkerClicked=="function"){options.onMarkerClicked.apply(this,[point]);}});$(this).data("map").entities.push(pushpin);},openMarker:function(marker){var display=$(this).data("Infobox");if(display){$(this).data("map").entities.remove(display);}var infoHtml=$(this).pdwMap("formatInfo",marker),infoboxOptions={title:infoHtml.title,description:infoHtml.content};if(marker.sells&&marker.sells.length>0){infoboxOptions.height=200;}display=new Microsoft.Maps.Infobox(new Microsoft.Maps.Location(marker.lat,marker.lng),infoboxOptions);$(this).data("Infobox",display);$(this).data("map").entities.push(display);},closeMarker:function(){if($(this).data("Infobox")){$(this).data("map").entities.remove($(this).data("Infobox"));}},centerMap:function(){var bounds=[];$.each($(this).data("markers"),function(i,n){bounds.push(n);});var bestview=Microsoft.Maps.LocationRect.fromLocations(bounds);$(this).data("map").setView({bounds:bestview});},setCenter:function(lat,lng,radius){var options=$(this).data("options");if(options.circle===false){return;}var R=6371,backgroundColor=Microsoft.Maps.Color.fromHex(options.maps.circle.fill),borderColor=Microsoft.Maps.Color.fromHex(options.maps.circle.stroke),circlePoints=[],d=parseFloat(radius)/R;backgroundColor.a=60;lat=(lat*Math.PI)/180;lng=(lng*Math.PI)/180;for(var x=0;x<=360;x++){var p2=new Microsoft.Maps.Location(0,0),brng=x*Math.PI/180;p2.latitude=Math.asin(Math.sin(lat)*Math.cos(d)+Math.cos(lat)*Math.sin(d)*Math.cos(brng));p2.longitude=((lng+Math.atan2(Math.sin(brng)*Math.sin(d)*Math.cos(lat),Math.cos(d)-Math.sin(lat)*Math.sin(p2.latitude)))*180)/Math.PI;p2.latitude=(p2.latitude*180)/Math.PI;circlePoints.push(p2);}var polygon=new Microsoft.Maps.Polygon(circlePoints,{fillColor:backgroundColor,strokeColor:borderColor,strokeThickness:1});$(this).data("map").entities.push(polygon);$(this).data("circleArea",polygon);}}});
/**
 * Cloudmade API provider
 * http://www.cloudmade.com
 */
jQuery.extend(jQuery.fn.pdwMap.providers,{cloudmade:{loadScript:function(){var options=$(this).data("options");if(typeof options.apiKeys.cloudmade=="undefined"){$.error("You need an api key for Cloudmade");return;}__pdw_map_loader=$(this);if(options.staticMap){pdwMapInit();return;}var script=document.createElement("script");script.setAttribute("type","text/javascript");script.setAttribute("src","http://tile.cloudmade.com/wml/latest/web-maps-lite.js");script.onload=script.onreadystatechange=function(){if(script.readyState&&script.readyState!="loaded"&&script.readyState!="complete"){return;}script.onload=script.onreadystatechange=null;pdwMapInit();};$(this).pdwMap("_appendScriptToHead",script);},initProvider:function(){var options=$(this).data("options");if(options.staticMap){var url="http://staticmaps.cloudmade.com/"+options.apiKeys.cloudmade+"/staticmap?center="+options.defaultPosition.lat+","+options.defaultPosition.lng+"&zoom="+options.maps.zoom+"&size="+$(this).pdwMap("_containerSize","x");$(this).pdwMap("_setMapImage",url);return null;}$(this).pdwMap("_hideOverlay");$(this).data("markers",[]);var center=new CM.LatLng(options.defaultPosition.lat,options.defaultPosition.lng);if(options.browserGeoloc&&navigator.geolocation){navigator.geolocation.getCurrentPosition(function(position){map.setCenter(new CM.LatLng(position.coords.latitude,position.coords.longitude),options.maps.zoom);},function(){});}var cloudmade=new CM.Tiles.CloudMade.Web({key:options.apiKeys.cloudmade}),map=new CM.Map($(this).attr("id"),cloudmade),$this=$(this);$(this).data("map",map);CM.Event.addListener(map,"load",function(){if(options.onMapLoaded&&typeof options.onMapLoaded=="function"){options.onMapLoaded.apply($this,$this);options.onMapLoaded=false;}});map.setCenter(center,options.maps.zoom);map.addControl(new CM.ScaleControl());map.addControl(new CM.LargeMapControl());CM.Event.addListener(map,"zoomend",function(){if($this.data("circleArea")){var zoom=map.getZoom();$this.data("circleArea")[zoom<=10?"show":"hide"]();}});return map;},cleanMarkers:function(){var map=$(this).data("map");if($(this).data("markers")){$.each($(this).data("markers"),function(i,n){map.removeOverlay(n);});}$(this).data("markers",[]);},cleanCircle:function(){if($(this).data("circleArea")){$(this).data("map").removeOverlay($(this).data("circleArea"));$(this).data("circleArea",null);}},addMarker:function(point){var options=$(this).data("options"),map=$(this).data("map"),infoHtml=$(this).pdwMap("formatInfo",point),markerOptions={title:infoHtml.title,clickable:true};if(options.marker!=false){if(typeof options.marker.anchor=="undefined"){options.marker.anchor={x:0,y:0};}var iconUrl=options.marker.url;if(options.marker.dynamic){iconUrl+="?type="+point.type;}var icon=new CM.Icon();icon.image=iconUrl;icon.iconSize=new CM.Size(options.marker.size.width,options.marker.size.height);icon.iconAnchor=new CM.Point(options.marker.anchor.x,options.marker.anchor.y);markerOptions.icon=icon;}var loc=new CM.LatLng(point.lat,point.lng),marker=new CM.Marker(loc,markerOptions);CM.Event.addListener(marker,"click",function(pos){marker.openInfoWindow("<h2>"+infoHtml.title+"</h2>"+infoHtml.content);if(options.onMarkerClicked&&typeof options.onMarkerClicked=="function"){options.onMarkerClicked.apply(this,[point]);}});map.addOverlay(marker);$(this).data("markers").push(marker);},openMarker:function(marker){if($(this).data("markers")){var loc=new CM.LatLng(marker.lat,marker.lng),infoHtml=$(this).pdwMap("formatInfo",marker);$.each($(this).data("markers"),function(i,n){if(n.getLatLng().lat()==loc.lat()&&n.getLatLng().lng()==loc.lng()&&n.getTitle()==infoHtml.title){n.openInfoWindow("<h2>"+infoHtml.title+"</h2>"+infoHtml.content);}});}},closeMarker:function(){if($(this).data("markers")){$.each($(this).data("markers"),function(i,n){n.closeInfoWindow();});}},centerMap:function(){var bounds;$.each($(this).data("markers"),function(i,n){if(!bounds){bounds=new CM.LatLngBounds(n.getLatLng(),n.getLatLng());}else{bounds.extend(n.getLatLng());}});$(this).data("map").zoomToBounds(bounds);},setCenter:function(lat,lng,radius){var options=$(this).data("options");if(options.circle===false){return;}radius*=1000;var map=$(this).data("map"),getLngRadius=function(mRadius){var equatorLength=40075017,hLength=equatorLength*Math.cos(Math.PI/180*map.getCenter().lat());return(mRadius/hLength)*360;},getPixRadius=function(lat,lng,mRadius){var lngRadius=getLngRadius(mRadius),latlng2=new CM.LatLng(lat,lng-lngRadius,true),point2=map.fromLatLngToContainerPixel(latlng2),point=map.fromLatLngToContainerPixel(new CM.LatLng(lat,lng));return Math.round(point.x-point2.x);},circleArea=new CM.Circle(new CM.LatLng(lat,lng),getPixRadius(lat,lng,radius),options.maps.circle.stroke,1,0.6,options.maps.circle.fill,0.15);circleArea._wantedRadius=radius;map.addOverlay(circleArea);$(this).data("circleArea",circleArea);CM.Event.addListener(map,"zoomend",function(){circleArea._radius=getPixRadius(circleArea._latlng.lat(),circleArea._latlng.lng(),circleArea._wantedRadius);circleArea.redraw();});}}});
/**
 * Google Maps API provider
 * https://developers.google.com/maps/
 */
jQuery.extend(jQuery.fn.pdwMap.providers,{gmaps:{loadScript:function(){var options=$(this).data("options");__pdw_map_loader=$(this);if(options.staticMap){pdwMapInit();return;}var script=document.createElement("script"),apiKey="";script.setAttribute("type","text/javascript");if(options.apiKeys&&options.apiKeys.gmaps){apiKey="key="+options.apiKeys.gmaps+"&";}script.setAttribute("src","http://maps.google.com/maps/api/js?"+apiKey+"sensor=true&region="+options.lang+"&callback=pdwMapInit");$(this).pdwMap("_appendScriptToHead",script);},initProvider:function(){var $this=$(this),options=$this.data("options");if(options.staticMap){var url="http://maps.googleapis.com/maps/api/staticmap?size="+$this.pdwMap("_containerSize","x")+"&maptype=roadmap&language="+options.lang+"&center="+options.defaultPosition.lat+","+options.defaultPosition.lng+"&zoom="+options.maps.zoom+"&sensor=true";$(this).pdwMap("_setMapImage",url);return null;}var mapOptions={zoom:options.maps.zoom,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},navigationControl:true,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}},map=new google.maps.Map($this.get(0),mapOptions);google.maps.event.addListener(map,"zoom_changed",function(){if($this.data("circleArea")){var zoom=map.getZoom();$this.data("circleArea").setVisible(zoom<=10);}});$this.data("markers",[]);$this.data("infoClientWindows",[]);var center=new google.maps.LatLng(options.defaultPosition.lat,options.defaultPosition.lng);if(options.browserGeoloc&&navigator.geolocation){navigator.geolocation.getCurrentPosition(function(position){map.setCenter(new google.maps.LatLng(position.coords.latitude,position.coords.longitude));},function(){});}google.maps.event.addListener(map,"idle",function(){$this.pdwMap("_hideOverlay");if(options.onMapLoaded&&typeof options.onMapLoaded=="function"){options.onMapLoaded.apply($this,$this);options.onMapLoaded=false;}});map.setCenter(center);return map;},cleanMarkers:function(){if($(this).data("markers")){$.each($(this).data("markers"),function(i,n){n.setMap(null);});}$(this).data("markers",[]);$(this).data("infoClientWindows",[]);},cleanCircle:function(){if($(this).data("circleArea")){$(this).data("circleArea").setMap(null);$(this).data("circleArea",null);}},addMarker:function(point){var $this=$(this),options=$this.data("options"),markerOptions={position:new google.maps.LatLng(point.lat,point.lng),map:$this.data("map")};if(options.marker!==false){if(typeof options.marker.origin=="undefined"){options.marker.origin={x:0,y:0};}if(typeof options.marker.anchor=="undefined"){options.marker.anchor={x:0,y:0};}var size=new google.maps.Size(options.marker.size.width,options.marker.size.height),origin=new google.maps.Point(options.marker.origin.x,options.marker.origin.y),anchor=new google.maps.Point(options.marker.anchor.x,options.marker.anchor.y),iconUrl=options.marker.url;if(options.marker.dynamic){iconUrl+="?type="+point.type;}markerOptions.icon=new google.maps.MarkerImage(iconUrl,size,origin,anchor);}var marker=new google.maps.Marker(markerOptions);if(options.marker!==false&&options.marker.shadow!==false){size=new google.maps.Size(options.marker.shadow.size.width,options.marker.shadow.size.height);if(typeof options.marker.shadow.origin=="undefined"){options.marker.shadow.origin={x:0,y:0};}origin=new google.maps.Point(options.marker.shadow.origin.x,options.marker.shadow.origin.y);if(typeof options.marker.shadow.anchor=="undefined"){options.marker.shadow.anchor={x:0,y:0};}anchor=new google.maps.Point(options.marker.shadow.anchor.x,options.marker.shadow.anchor.y);marker.setShadow(new google.maps.MarkerImage(options.marker.shadow.url,size,origin,anchor));}$this.data("markers").push(marker);var infoHtml=$this.pdwMap("formatInfo",point),infoClientWindow=new google.maps.InfoWindow({content:"<h2>"+infoHtml.title+"</h2>"+infoHtml.content});$this.data("infoClientWindows").push(infoClientWindow);marker.setTitle(infoHtml.title);var openMarker=function(){$.each($this.data("infoClientWindows"),function(i,n){n.close();});infoClientWindow.open($this.data("map"),marker);if(options.onMarkerClicked&&typeof options.onMarkerClicked=="function"){options.onMarkerClicked.apply(this,[point]);}};google.maps.event.addListener(marker,"click",openMarker);},openMarker:function(marker){var $this=$(this);if($this.data("markers")){var loc=new google.maps.LatLng(marker.lat,marker.lng),infoHtml=$this.pdwMap("formatInfo",marker),title=infoHtml.title;$.each($this.data("markers"),function(i,n){if(n.getPosition().lat()==loc.lat()&&n.getPosition().lng()==loc.lng()&&n.getTitle()==title){var infoClientWindow=new google.maps.InfoWindow({content:"<h2>"+infoHtml.title+"</h2>"+infoHtml.content});$this.data("infoClientWindows").push(infoClientWindow);$.each($this.data("infoClientWindows"),function(i,n){n.close();});infoClientWindow.open($this.data("map"),n);}});}},closeMarker:function(){if($this.data("infoClientWindows")){$.each($this.data("infoClientWindows"),function(i,n){n.close();});}},centerMap:function(){var bounds=new google.maps.LatLngBounds();$.each($(this).data("markers"),function(i,n){bounds.extend(n.getPosition());});$(this).data("map").setCenter(bounds.getCenter());$(this).data("map").fitBounds(bounds);},setCenter:function(lat,lng,radius){var options=$(this).data("options");if(options.circle===false){return;}var circleArea=new google.maps.Circle({strokeColor:options.maps.circle.stroke,strokeOpacity:0.6,strokeWeight:1,fillColor:options.maps.circle.fill,fillOpacity:0.15,map:$(this).data("map"),center:new google.maps.LatLng(lat,lng),radius:radius*1000});$(this).data("circleArea",circleArea);}}});
/**
 * OpenLayers API provider
 * http://openlayers.org/
 */
jQuery.extend(jQuery.fn.pdwMap.providers,{openlayers:{loadScript:function(){__pdw_map_loader=$(this);var options=$(this).data("options");if(options.staticMap){pdwMapInit();return;}var script=document.createElement("script");script.setAttribute("type","text/javascript");script.setAttribute("src","http://www.openlayers.org/api/OpenLayers.js");script.onload=script.onreadystatechange=function(){if(script.readyState&&script.readyState!="loaded"&&script.readyState!="complete"){return;}script.onload=script.onreadystatechange=null;pdwMapInit();};$(this).pdwMap("_appendScriptToHead",script);},initProvider:function(){var options=$(this).data("options");if(options.staticMap){var url="http://pafciu17.dev.openstreetmap.org/?module=map&center="+options.defaultPosition.lng+","+options.defaultPosition.lat+"&zoom="+options.maps.zoom+"&width="+$(this).pdwMap("_containerSize","&height=");$(this).pdwMap("_setMapImage",url);return null;}$(this).data("markers",[]);var center=new OpenLayers.LonLat(options.defaultPosition.lng,options.defaultPosition.lat);if(options.browserGeoloc&&navigator.geolocation){navigator.geolocation.getCurrentPosition(function(position){map.setCenter(new OpenLayers.LonLat(position.coords.longitude,position.coords.latitude).transform(fromProjection,map.getProjectionObject()),options.maps.zoom);},function(){});}var fromProjection=new OpenLayers.Projection("EPSG:4326"),map=new OpenLayers.Map($(this).attr("id"),{sphericalMercator:true,maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34)}),$this=$(this),circleAreaLayer=new OpenLayers.Layer.Vector("circleArea");map.addLayer(new OpenLayers.Layer.OSM());map.addLayer(circleAreaLayer);$(this).data("circleAreaLayer",circleAreaLayer);map.events.register("zoomend",map,function(){if($this.data("circleArea")){var zoom=map.getZoom();$this.data("circleArea").style={strokeOpacity:zoom<=10?0.6:0,fillOpacity:zoom<=10?0.15:0,strokeColor:options.maps.circle.stroke,fillColor:options.maps.circle.fill,strokeWidth:1};$this.data("circleAreaLayer")[zoom<=10?"addFeatures":"removeFeatures"]([$this.data("circleArea")]);$this.data("circleAreaLayer").redraw();}});map.setCenter(center.transform(fromProjection,map.getProjectionObject()),options.maps.zoom);if(options.onMapLoaded&&typeof options.onMapLoaded=="function"){setTimeout(function(){options.onMapLoaded.apply($this,$this);options.onMapLoaded=false;},250);}$(this).pdwMap("_hideOverlay");return map;},cleanMarkers:function(){var map=$(this).data("map");if($(this).data("markersLayer")){map.removeLayer($(this).data("markersLayer"));$(this).data("markersLayer").destroy();$(this).data("markersLayer",null);}$(this).data("markers",[]);},cleanCircle:function(){if($(this).data("circleArea")){$(this).data("circleArea").destroy();$(this).data("circleArea",null);}},addMarker:function(point){var options=$(this).data("options"),map=$(this).data("map"),lonLat=new OpenLayers.LonLat(point.lng,point.lat).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject()),markers=$(this).data("markersLayer");if(!markers){markers=new OpenLayers.Layer.Markers("Markers");$(this).data("markersLayer",markers);}map.addLayer(markers);var icon=null;if(options.marker!=false){if(typeof options.marker.anchor=="undefined"){options.marker.anchor={x:0,y:0};}var iconUrl=options.marker.url;if(options.marker.dynamic){iconUrl+="?type="+point.type;}var size=new OpenLayers.Size(options.marker.size.width,options.marker.size.height),offset=new OpenLayers.Pixel(options.marker.anchor.x,options.marker.anchor.y);icon=new OpenLayers.Icon(iconUrl,size,offset);}var marker=new OpenLayers.Marker(lonLat,icon),$this=$(this);marker.events.register("mousedown",marker,function(evt){OpenLayers.Event.stop(evt);var popup=$this.data("openPopup");if(popup){map.removePopup(popup);}var infoHtml=$this.pdwMap("formatInfo",point);popup=new OpenLayers.Popup("chicken",lonLat,null,"<h2>"+infoHtml.title+"</h2>"+infoHtml.content,true);map.addPopup(popup);$this.data("openPopup",popup);if(options.onMarkerClicked&&typeof options.onMarkerClicked=="function"){options.onMarkerClicked.apply(this,[point]);}});markers.addMarker(marker);$(this).data("markers").push(lonLat);},openMarker:function(marker){var popup=$(this).data("openPopup");if(popup){$(this).data("map").removePopup(popup);}var lonLat=new OpenLayers.LonLat(marker.lng,marker.lat).transform(new OpenLayers.Projection("EPSG:4326"),$(this).data("map").getProjectionObject()),infoHtml=$(this).pdwMap("formatInfo",marker);popup=new OpenLayers.Popup("chicken",lonLat,null,"<h2>"+infoHtml.title+"</h2>"+infoHtml.content,true);$(this).data("map").addPopup(popup);$(this).data("openPopup",popup);},closeMarker:function(){if($(this).data("openPopup")){$(this).data("map").removePopup($(this).data("openPopup"));}},centerMap:function(){var bounds=new OpenLayers.Bounds();$.each($(this).data("markers"),function(i,n){bounds.extend(n);});$(this).data("map").zoomToExtent(bounds,false);},_createGeodesicPolygon:function(latlon,radius,sides,rotation,projection){if(projection.getCode()!=="EPSG:4326"){latlon.transform(projection,new OpenLayers.Projection("EPSG:4326"));}var angle,newLonlat,geomPoint,points=[];for(var i=0;i<sides;i++){angle=(i*360/sides)+rotation;newLonlat=OpenLayers.Util.destinationVincenty(latlon,angle,radius);newLonlat.transform(new OpenLayers.Projection("EPSG:4326"),projection);geomPoint=new OpenLayers.Geometry.Point(newLonlat.lon,newLonlat.lat);points.push(geomPoint);}var ring=new OpenLayers.Geometry.LinearRing(points);return new OpenLayers.Geometry.Polygon([ring]);},setCenter:function(lat,lng,radius){var map=$(this).data("map"),options=$(this).data("options");if(options.circle===false){return;}radius*=1000;var origin=new OpenLayers.LonLat(lng,lat).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject()),circle=$(this).pdwMap("_createGeodesicPolygon",origin,radius,50,0,map.getProjectionObject()),circleAreaLayer=$(this).data("circleAreaLayer"),circleArea=new OpenLayers.Feature.Vector(circle,null,{strokeColor:options.maps.circle.stroke,strokeOpacity:0.6,fillColor:options.maps.circle.fill,fillOpacity:0.15,strokeWidth:1});circleAreaLayer.addFeatures([circleArea]);$(this).data("circleArea",circleArea);}}});
/**
 * OVI API provider
 * http://api.maps.ovi.com
 */
jQuery.extend(jQuery.fn.pdwMap.providers,{ovi:{_loadScripts:function(i){var scripts=["http://api.maps.ovi.com/base.js","http://api.maps.ovi.com/search-nokia.js","http://api.maps.ovi.com/routing-nokia.js","http://api.maps.ovi.com/positioning-w3c.js","http://api.maps.ovi.com/gfx-canvas.js","http://api.maps.ovi.com/map-js-p2d-dom.js","http://api.maps.ovi.com/ui-ovi_web.js","http://api.maps.ovi.com/language-fr-FR.js"];var script=document.createElement("script");script.setAttribute("type","text/javascript");script.setAttribute("src",scripts[i]);var $this=$(this);script.onload=script.onreadystatechange=function(){if(script.readyState&&script.readyState!="loaded"&&script.readyState!="complete"){return;}script.onload=script.onreadystatechange=null;if(i==scripts.length-1){pdwMapInit();}else{$this.pdwMap("_loadScripts",++i);}};$(this).pdwMap("_appendScriptToHead",script);},loadScript:function(){var options=$(this).data("options");if(typeof options.apiKeys.oviAppId=="undefined"||typeof options.apiKeys.ovi=="undefined"){$.error("You need an app ID and authentication token for OVI");return;}__pdw_map_loader=$(this);var script=document.createElement("script");script.setAttribute("type","text/javascript");script.setAttribute("src","http://api.maps.ovi.com/jsl.js");var $this=$(this);script.onload=script.onreadystatechange=function(){if(script.readyState&&script.readyState!="loaded"&&script.readyState!="complete"){return;}script.onload=script.onreadystatechange=null;$this.pdwMap("_loadScripts",0);};$(this).pdwMap("_appendScriptToHead",script);},initProvider:function(){var options=$(this).data("options");ovi.mapsapi.util.ApplicationContext.set({appId:options.apiKeys.oviAppId,authenticationToken:options.apiKeys.ovi});ovi.mapsapi.util.ApplicationContext.set("defaultLanguage",options.lang);var center=[options.defaultPosition.lat,options.defaultPosition.lng];if(options.browserGeoloc&&navigator.geolocation){navigator.geolocation.getCurrentPosition(function(position){map.setCenter(new ovi.mapsapi.geo.Coordinate(position.coords.latitude,position.coords.longitude));},function(){});}var components=[];if(!options.staticMap){var infoBubbles=new ovi.mapsapi.map.component.InfoBubbles();components=[new ovi.mapsapi.map.component.Behavior(),new ovi.mapsapi.map.component.TypeSelector(),new ovi.mapsapi.map.component.ZoomBar(),new ovi.mapsapi.map.component.ViewControl(),new ovi.mapsapi.map.component.RightClick(),infoBubbles];$(this).data("infoBubbles",infoBubbles);}$(this).data("locs",[]);$(this).data("markers",[]);var $this=$(this),map=new ovi.mapsapi.map.Display($(this).get(0),{zoomLevel:options.maps.zoom,center:center,components:components,eventListener:{mapviewchangeend:[function(event){var map=$this.data("map");if($this.data("circleArea")){var zoom=map.zoomLevel;$this.data("circleArea").visibility=zoom<=10;map.update(10,false);}if(options.onMapLoaded&&typeof options.onMapLoaded=="function"){options.onMapLoaded.apply($this,$this);options.onMapLoaded=false;}},true,null]},fading:250});$(this).pdwMap("_hideOverlay");return map;},cleanMarkers:function(){var $this=$(this);if($(this).data("markers")){$.each($(this).data("markers"),function(i,n){if(typeof n!="function"){$this.data("map").objects.remove(n);}});}$(this).data("locs",[]);$(this).data("markers",[]);},cleanCircle:function(){},addMarker:function(point){var options=$(this).data("options"),map=$(this).data("map"),$this=$(this),markerOptions={eventListener:{click:[function(event){$this.pdwMap("closeMarker");var infoHtml=$this.pdwMap("formatInfo",point);var infoBubbles=$this.data("infoBubbles");var bubble=infoBubbles.addBubble("<h2>"+infoHtml.title+"</h2>"+infoHtml.content,new ovi.mapsapi.geo.Coordinate(point.lat,point.lng));$this.data("bubble",bubble);if(options.onMarkerClicked&&typeof options.onMarkerClicked=="function"){options.onMarkerClicked.apply(this,[point]);}},false,null]}};if(options.marker!=false){var iconUrl=options.marker.url;if(options.marker.dynamic){iconUrl+="?type="+point.type;}markerOptions.icon=iconUrl;}var marker=new ovi.mapsapi.map.Marker([point.lat,point.lng],markerOptions);map.objects.add(marker);$(this).data("markers").push(marker);$(this).data("locs").push([point.lat,point.lng]);},openMarker:function(marker){$(this).pdwMap("closeMarker");var infoHtml=$(this).pdwMap("formatInfo",marker),infoBubbles=$(this).data("infoBubbles"),bubble=infoBubbles.addBubble("<h2>"+infoHtml.title+"</h2>"+infoHtml.content,new ovi.mapsapi.geo.Coordinate(marker.lat,marker.lng));$(this).data("bubble",bubble);},closeMarker:function(){if(undefined!=$(this).data("bubble")){var infoBubbles=$(this).data("infoBubbles"),bubble=$(this).data("bubble");if(infoBubbles.bubbleExists(bubble)){infoBubbles.removeBubble(bubble);}}},centerMap:function(){var bounds=[];$.each($(this).data("locs"),function(i,n){bounds.push(new ovi.mapsapi.geo.Coordinate(n[0],n[1]));});var boundingBox=ovi.mapsapi.geo.BoundingBox.coverAll(bounds),zoom=$(this).data("map").getBestZoomLevel([boundingBox]);$(this).data("map").setZoomLevel(zoom,"default");$(this).data("map").setCenter(boundingBox.getCenter());},setCenter:function(lat,lng,radius){var options=$(this).data("options");if(options.circle===false){return;}radius*=1000;var coord=new ovi.mapsapi.geo.Coordinate(lat,lng),circle=new ovi.mapsapi.map.Circle(coord,radius,{pen:{strokeColor:options.maps.circle.stroke+"7F",lineWidth:1},brush:{color:options.maps.circle.fill+"2F"}});$(this).data("map").objects.add(circle);$(this).data("circleArea",circle);}}});
/**
 * Yandex Maps API provider
 * http://api.yandex.ru/maps/
 */
jQuery.extend(jQuery.fn.pdwMap.providers,{yandex:{_loadScripts:function(){var $this=$(this);setTimeout(function(){if(ymaps&&ymaps.Map){pdwMapInit();}else{$this.pdwMap("_loadScripts");}},100);},loadScript:function(){var options=$(this).data("options");if(typeof options.apiKeys.yandex=="undefined"){$.error("You need an api key for Yandex");return;}__pdw_map_loader=$(this);var script=document.createElement("script"),$this=$(this),apiKey="";script.setAttribute("type","text/javascript");if(options.apiKeys&&options.apiKeys.yandex){apiKey="&key="+options.apiKeys.yandex;}script.setAttribute("src","http://api-maps.yandex.ru/2.0/?load=package.full"+apiKey+"&lang="+options.lang);script.onload=script.onreadystatechange=function(){if(script.readyState&&script.readyState!="loaded"&&script.readyState!="complete"){return;}script.onload=script.onreadystatechange=null;$this.pdwMap("_loadScripts");};$(this).pdwMap("_appendScriptToHead",script);},initProvider:function(){var options=$(this).data("options"),$this=$(this),map=new ymaps.Map($(this).attr("id"),{center:[options.defaultPosition.lat,options.defaultPosition.lng],zoom:options.maps.zoom});map.controls.add("zoomControl").add("typeSelector");$this.pdwMap("_hideOverlay");var center=[options.defaultPosition.lat,options.defaultPosition.lng];if(options.browserGeoloc&&navigator.geolocation){navigator.geolocation.getCurrentPosition(function(position){map.panTo([position.coords.latitude,position.coords.longitude]);},function(){});}return map;},cleanMarkers:function(){var $this=$(this);$(this).data("map").geoObjects.each(function(i){$this.data("map").geoObjects.remove(i);});},cleanCircle:function(){},addMarker:function(point){var options=$(this).data("options"),infoHtml=$(this).pdwMap("formatInfo",point),marker;if(options.marker!=false){var iconUrl=options.marker.url;if(options.marker.dynamic){iconUrl+="?type="+point.type;}marker=new ymaps.Placemark([point.lat,point.lng],{balloonContent:"<h2>"+infoHtml.title+"</h2>"+infoHtml.content},{iconImageHref:iconUrl,iconImageSize:[options.marker.size.width,options.marker.size.height],iconImageOffset:[options.marker.origin.x,options.marker.origin.y]});}else{marker=new ymaps.Placemark([point.lat,point.lng]);}$(this).data("map").geoObjects.add(marker);},openMarker:function(marker){var $this=$(this);$(this).data("map").geoObjects.each(function(i){var coordinates=i.geometry.getCoordinates();if(coordinates[0]==marker.lat&&coordinates[1]==marker.lng){i.balloon.open($this.data("map").getCenter());}});},closeMarker:function(){$(this).data("map").geoObjects.each(function(i){i.balloon.close();});},centerMap:function(){var lower=null,upper=null;$(this).data("map").geoObjects.each(function(i){var coords=i.geometry.getCoordinates();if(lower==null||lower[0]>coords[0]||lower[1]<coords[1]){lower=coords;}if(upper==null||upper[0]<coords[0]||upper[1]>coords[1]){upper=coords;}});var options=$(this).data("options");ymaps.util.bounds.getCenterAndZoom([lower,upper],[$(this).width(),$(this).height()]);$(this).data("map").setBounds([lower,upper],{checkZoomRange:true});},setCenter:function(lat,lng,radius){var options=$(this).data("options");if(options.circle===false){return;}}}});
